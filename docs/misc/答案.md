# å›ç­”: æ˜¯å¦å¯ä»¥å®ç° JSON â†’ FFmpeg å‘½ä»¤çš„è½¬æ¢?

## âœ… ç­”æ¡ˆ: **å®Œå…¨å¯ä»¥!è€Œä¸”å·²ç»å®ç°äº†!**

---

## ğŸ“‹ ä½ çš„éœ€æ±‚

> è¾“å…¥: `worker/test/fixtures/simple-timeline.json`
> è¾“å‡º: å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥æ‰§è¡Œçš„ FFmpeg å‘½ä»¤è¡Œå­—ç¬¦ä¸²
> å¹³å°: Cloudflare Worker API

---

## ğŸ¯ å®ç°æ–¹å¼ (ä¸¤ç§)

### æ–¹å¼ä¸€: ç›´æ¥ä½¿ç”¨ Node.js (æœ¬åœ°)

**æœ€ç®€å•çš„æ–¹å¼,æ— éœ€å¯åŠ¨ Worker**

```bash
# å®‰è£…ä¾èµ–å¹¶æ„å»º
npm install
npm run build

# ç”Ÿæˆ FFmpeg å‘½ä»¤
node demo-generate-command.js worker/test/fixtures/simple-timeline.json

# ä¿å­˜åˆ°æ–‡ä»¶
node demo-generate-command.js worker/test/fixtures/simple-timeline.json > output.sh

# ç›´æ¥æ‰§è¡Œ
bash output.sh
```

**è¾“å‡ºç¤ºä¾‹**:
```bash
#!/bin/bash
mkdir -p ./tmp
ffmpeg -y -i samples/bee1920.mp4 -ss 27 -t 5 -r 30 ./tmp/clip4.mp4
ffmpeg -y -i samples/book1920.mp4 -ss 0 -t 5 -r 30 ./tmp/clip5.mp4
ffmpeg -y \
-i ./tmp/clip4.mp4 \
-i ./tmp/clip5.mp4 \
-filter_complex "color=c=black:s=384x216:d=8[base];
...å®Œæ•´çš„æ»¤é•œé“¾...
[base][track_with_some_videos]overlay=0:0[video_output];
anullsrc=channel_layout=stereo:sample_rate=44100:d=8[audio_output];" \
-map '[video_output]' -map '[audio_output]' -c:v libx264 -c:a aac -b:a 320k -r 30 -s 384x216 -ss 0 -t 8 -crf 23 -preset veryfast -pix_fmt yuv420p output.mp4
```

âœ… **è¿™ä¸ªè¾“å‡ºå¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°å‘½ä»¤è¡Œæ‰§è¡Œ!**

---

### æ–¹å¼äºŒ: ä½¿ç”¨ Cloudflare Worker API

**æ›´çµæ´»,é€‚åˆ Web åº”ç”¨å’Œå¾®æœåŠ¡**

#### 1. å¯åŠ¨ Worker

```bash
cd worker
npm install
npm run dev
```

Worker è¿è¡Œåœ¨: `http://localhost:8787`

#### 2. è°ƒç”¨ API

**ä½¿ç”¨ curl**:
```bash
# å‘é€ JSON,è·å– FFmpeg å‘½ä»¤
curl -X POST http://localhost:8787/build \
  -H "Content-Type: application/json" \
  -d @worker/test/fixtures/simple-timeline.json
```

**API å“åº”**:
```json
{
  "command": "#!/bin/bash\nmkdir -p ./tmp\nffmpeg -y ...",
  "args": ["-y", "-i", "samples/bee1920.mp4", ...],
  "warnings": []
}
```

#### 3. æå–å‘½ä»¤

**ä½¿ç”¨ jq æå– command å­—æ®µ**:
```bash
curl -s -X POST http://localhost:8787/build \
  -H "Content-Type: application/json" \
  -d @worker/test/fixtures/simple-timeline.json \
  | jq -r '.command' > output.sh

# æ‰§è¡Œ
bash output.sh
```

**æˆ–ä½¿ç”¨æä¾›çš„è„šæœ¬**:
```bash
cd worker
./examples/extract-command.sh test/fixtures/simple-timeline.json output.sh
bash output.sh
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å¿«é€Ÿæµ‹è¯•

```bash
# æ–¹å¼ 1: Node.js ç›´æ¥ç”Ÿæˆ
npm run build
node demo-generate-command.js worker/test/fixtures/simple-timeline.json

# æ–¹å¼ 2: Worker API æµ‹è¯•
cd worker
npm run dev  # å¯åŠ¨ Worker (å¦ä¸€ä¸ªç»ˆç«¯)
./test-api-complete.sh  # è¿è¡Œå®Œæ•´æµ‹è¯•
```

### æµ‹è¯•å·²é€šè¿‡ âœ…

```bash
$ npm test

 âœ“ test/tokenizer.test.ts  (7 tests) 2ms
 âœ“ test/build.test.ts  (5 tests) 3ms

 Test Files  2 passed (2)
      Tests  12 passed (12)
```

---

## ğŸ“Š API ç«¯ç‚¹

### POST /build

**åŠŸèƒ½**: ç”Ÿæˆ FFmpeg å‘½ä»¤

**è¯·æ±‚**:
```bash
POST http://localhost:8787/build
Content-Type: application/json

{
  "version": 1,
  "inputs": {...},
  "tracks": {...},
  "transitions": [...],
  "output": {...}
}
```

**å“åº”**:
```json
{
  "command": "å®Œæ•´çš„ shell è„šæœ¬å­—ç¬¦ä¸² (å¯ç›´æ¥æ‰§è¡Œ)",
  "args": ["å‚æ•°æ•°ç»„", "ç”¨äºç¼–ç¨‹è°ƒç”¨"],
  "warnings": ["å¯é€‰çš„è­¦å‘Šä¿¡æ¯"]
}
```

### GET /version

æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯

### GET /health

å¥åº·æ£€æŸ¥

---

## ğŸ’¡ å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: æœ¬åœ°æ‰¹å¤„ç†

```bash
#!/bin/bash
# æ‰¹é‡å¤„ç†å¤šä¸ªæ—¶é—´çº¿

for timeline in timelines/*.json; do
  echo "Processing $timeline..."
  node demo-generate-command.js "$timeline" | bash
done
```

### ç¤ºä¾‹ 2: Web åº”ç”¨è°ƒç”¨

```javascript
// å‰ç«¯å‘é€ timeline
const response = await fetch('https://your-worker.workers.dev/build', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(timeline)
});

const { command, args } = await response.json();

// å‘é€åˆ°åç«¯æ‰§è¡Œ
await executeFFmpeg(args);
```

### ç¤ºä¾‹ 3: CI/CD é›†æˆ

```yaml
# GitHub Actions ç¤ºä¾‹
- name: Generate video
  run: |
    node demo-generate-command.js timeline.json > ffmpeg.sh
    bash ffmpeg.sh

- name: Upload video
  uses: actions/upload-artifact@v2
  with:
    name: output-video
    path: output.mp4
```

---

## ğŸ¬ è¾“å…¥/è¾“å‡ºå¯¹ç…§

### è¾“å…¥: simple-timeline.json

```json
{
  "version": 1,
  "inputs": {
    "source1": {
      "type": "video",
      "file": "samples/bee1920.mp4",
      "duration": 40
    },
    "source2": {
      "type": "video",
      "file": "samples/book1920.mp4",
      "duration": 13
    }
  },
  "tracks": {
    "track_with_some_videos": {
      "type": "video",
      "clips": [
        {
          "name": "clip4",
          "source": "source1",
          "timelineTrackStart": 0,
          "duration": 5,
          "sourceStartOffset": 27,
          "transform": {...}
        },
        {
          "name": "clip5",
          "source": "source2",
          "timelineTrackStart": 3,
          "duration": 5,
          "sourceStartOffset": 0,
          "transform": {...}
        }
      ]
    }
  },
  "transitions": [
    {
      "type": "fade",
      "duration": 2,
      "from": "clip4",
      "to": "clip5"
    }
  ],
  "output": {
    "file": "output.mp4",
    "width": 1920,
    "height": 1080,
    "framerate": 30
  }
}
```

### è¾“å‡º: å¯æ‰§è¡Œçš„ FFmpeg å‘½ä»¤

```bash
#!/bin/bash
mkdir -p ./tmp
ffmpeg -y -i samples/bee1920.mp4 -ss 27 -t 5 -r 30 ./tmp/clip4.mp4
ffmpeg -y -i samples/book1920.mp4 -ss 0 -t 5 -r 30 ./tmp/clip5.mp4
ffmpeg -y \
-i ./tmp/clip4.mp4 \
-i ./tmp/clip5.mp4 \
-filter_complex "color=c=black:s=384x216:d=8[base];
color=black@0.0:s=384x216:d=5[QGWFN9b4_base];
[0:v]scale=384:216,format=rgba,colorchannelmixer=aa=1[vqUV2OLd_clip];
[QGWFN9b4_base][vqUV2OLd_clip]overlay=0:0:format=auto,rotate=0,fps=30[clip4];
color=black@0.0:s=384x216:d=5[nxgbBHAZ_base];
[1:v]scale=80:60,format=rgba,colorchannelmixer=aa=1[Yxsqw6dl_clip];
[nxgbBHAZ_base][Yxsqw6dl_clip]overlay=10:10:format=auto,rotate=0,fps=30[clip5];
[clip4]fps=30[fps_clip4_1oC9mqUE];
[clip5]fps=30[fps_clip5_GJoOclwP];
[fps_clip4_1oC9mqUE][fps_clip5_GJoOclwP]xfade=transition=fade:duration=2:offset=3,fps=30[track_with_some_videos];
[base][track_with_some_videos]overlay=0:0[video_output];
anullsrc=channel_layout=stereo:sample_rate=44100:d=8[audio_output];" \
-map '[video_output]' -map '[audio_output]' -c:v libx264 -c:a aac -b:a 320k -r 30 -s 384x216 -ss 0 -t 8 -crf 23 -preset veryfast -pix_fmt yuv420p output.mp4
```

âœ… **è¿™ä¸ªå‘½ä»¤å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œ!**

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **æ ¸å¿ƒåº“å…¥å£**: [src/index.ts](../../src/index.ts) - `parseSchema()` å‡½æ•°
- **Worker å…¥å£**: [worker/src/index.ts](../../worker/src/index.ts) - API è·¯ç”±
- **æ¼”ç¤ºè„šæœ¬**: [demo-generate-command.js](../../scripts/demo-generate-command.js) - æœ¬åœ°ç”Ÿæˆå‘½ä»¤
- **å®Œæ•´æµ‹è¯•**: [worker/test-api-complete.sh](../../worker/test-api-complete.sh) - Worker API æµ‹è¯•
- **æµ‹è¯•æ–‡ä»¶**: [worker/test/fixtures/simple-timeline.json](../../worker/test/fixtures/simple-timeline.json)

---

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

```bash
# é…ç½® wrangler.toml
cd worker
vim wrangler.toml  # æ·»åŠ è´¦å·ä¿¡æ¯

# éƒ¨ç½²
npm run deploy

# ä½¿ç”¨ç”Ÿäº§ URL
curl -X POST https://your-worker.workers.dev/build -d @timeline.json
```

---

## âœ¨ æ€»ç»“

### é—®é¢˜
> æ˜¯å¦å¯ä»¥åšåˆ° Cloudflare Worker æ¥å£,è¾“å…¥ JSON timeline,è¾“å‡ºå¯æ‰§è¡Œçš„ FFmpeg å‘½ä»¤å­—ç¬¦ä¸²?

### ç­”æ¡ˆ
âœ… **å®Œå…¨å¯ä»¥,è€Œä¸”å·²ç»å®ç°å¹¶æµ‹è¯•é€šè¿‡!**

### ä¸¤ç§æ–¹å¼
1. **æœ¬åœ° Node.js**: æ›´ç®€å•ç›´æ¥
   ```bash
   node demo-generate-command.js input.json > output.sh
   ```

2. **Worker API**: æ›´çµæ´»,é€‚åˆ Web åº”ç”¨
   ```bash
   curl -X POST http://localhost:8787/build -d @input.json | jq -r '.command'
   ```

### æ ¸å¿ƒç‰¹æ€§
- âœ… è¾“å…¥: JSON timeline
- âœ… è¾“å‡º: å¯ç›´æ¥æ‰§è¡Œçš„ FFmpeg å‘½ä»¤å­—ç¬¦ä¸²
- âœ… å¹³å°: Cloudflare Workers å…¼å®¹
- âœ… æ ¼å¼: Shell è„šæœ¬å­—ç¬¦ä¸² + å‚æ•°æ•°ç»„
- âœ… æµ‹è¯•: 12 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

**ç«‹å³å°è¯•**: `bash worker/test-api-complete.sh` ğŸ‰
