# 空 -i 参数 Bug 修复总结

## 问题描述

在实现文本渲染功能后，生成的 FFmpeg 命令中出现了两个空的 `-i` 参数：

```bash
ffmpeg -y \
-i ./tmp/background_clip.mp4 \
-i  \
-i  \
-filter_complex ...
```

这导致 FFmpeg 执行时报错：
```
-i: No such file or directory
```

## 问题原因

虽然在 [src/parseInputs.ts](src/parseInputs.ts) 中已经添加了跳过 `type === "text"` 输入的逻辑：

```typescript
for (const [inputName, input] of Object.entries(schema.inputs)) {
  if (input.type === "video" || input.type === "text") continue;

  inputsCommand += `-i ${input.file} \\\n`;  // 这里会生成空的 -i
  inputFiles.push({
    name: inputName,
    file: input.file,
  });
}
```

但问题在于代码修改后没有重新编译，或者编译时由于 TypeScript 配置问题（`checkJs: true`, `allowJs: true`）导致编译失败。

## 解决方案

### 1. 更新 TypeScript 配置

修改 [tsconfig.json](tsconfig.json)，使用 `include` 代替依赖 `exclude`，避免编译测试脚本：

```json
{
  "compilerOptions": {
    // ... 保持不变
    // 移除 "checkJs": true 和 "allowJs": true
  },
  "include": [
    "src/**/*"  // 只编译 src 目录
  ],
  "exclude": [
    "node_modules",
    "bin",
    "test",
    "coverage",
    "dist",
    "example",
    "worker",
    "scripts"
  ]
}
```

### 2. 确认 parseInputs.ts 的修复

代码已经正确跳过了 text 类型的输入：

```typescript
for (const [inputName, input] of Object.entries(schema.inputs)) {
  // Skip video inputs (handled in clips) and text inputs (generated by drawtext filter)
  if (input.type === "video" || input.type === "text") continue;

  inputsCommand += `-i ${input.file} \\\n`;
  inputFiles.push({
    name: inputName,
    file: input.file,
  });
}
```

### 3. 重新编译

```bash
rm -rf dist
npm run build
npm --prefix worker run build
```

## 验证结果

修复后生成的命令：

```bash
#!/bin/bash
mkdir -p ./tmp
ffmpeg -y -i samples/bee1920.mp4 -ss 0 -t 8 -r 30 ./tmp/background_clip.mp4
ffmpeg -y \
-i ./tmp/background_clip.mp4 \
-filter_complex "color=c=black:s=384x216:d=8[base];
...文本渲染滤镜...
[base][video_track]overlay=0:0[combined];
..." \
-map '[video_output]' -map '[audio_output]' \
-c:v libx264 -c:a aac -b:a 320k \
-r 30 -s 384x216 -ss 0 -t 8 -crf 23 \
-preset veryfast -pix_fmt yuv420p output.mp4
```

✅ **只有一个正确的 `-i` 参数**，不再有空的 `-i` 参数！

## 相关文件

- [src/parseInputs.ts](src/parseInputs.ts) - 跳过 text 类型输入
- [tsconfig.json](tsconfig.json) - TypeScript 配置优化
- [test-text-rendering.js](test-text-rendering.js) - 测试脚本
- [worker/test/fixtures/text-timeline.json](worker/test/fixtures/text-timeline.json) - 测试用例

## 测试

运行测试：
```bash
node test-text-rendering.js
```

检查生成的命令：
```bash
cat test-text-output.sh | grep "^-i"
```

预期输出：
```
-i ./tmp/background_clip.mp4 \
```

✅ 修复完成！
